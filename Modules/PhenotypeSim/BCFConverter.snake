# -*- coding: utf-8 -*-
"""
Created on Thu Aug  2 13:05:58 2018

@author: Masih
#Convert the result of multi-sample variant calling by GATK to a vcf file 
###Converts the vcf file generated by GATK to VCF file 
"""

rule BCFConverter:
    input:
        Genotypegvcf=expand("{outputDIR}/{simulations}/{{simulation_index}}/VarCall/GenotypeGVCF",outputDIR=config["outputDIR"],simulations=config["simulations"]),
        ref= expand("{outputDIR}/{SequenceDIR}/{fasta_output}",outputDIR=config["outputDIR"],SequenceDIR=config["SequenceDIR"],fasta_output=str(config["fasta_file"]).split('/')[-1]),
    output:
        expand("{outputDIR}/{simulations}/{{simulation_index}}/VarCall/BCFToolsRes",outputDIR=config["outputDIR"],simulations=config["simulations"]),
    params:
        bcftools=config['bcftools'],
        logNAME="BCFTools VCFToPlink Converter." + strftime("%Y-%m-%d.%H-%M-%S", localtime()),
    run:
        from subprocess import call
        callString="%s norm -Ou -m -any  %s | %s norm -Ou -f %s | %s annotate -x ID -I +%s -o %s" %(params.bcftools,str(input.Genotypegvcf),\
                                                                                   params.bcftools,str(input.ref),params.bcftools, "%CHROM:%POS:%REF:%ALT",str(output))
        call('echo "' + str(params.logNAME) + ':\n ' + callString + '\n" >> ' + config["ShellCallFile"], shell=True)
        call(callString, shell=True)                                                                         
                                         